name: Publish Studio Desktop for Linux in Flathub

on:
  workflow_dispatch:
  workflow_run:
    workflows: [ Publish Studio Desktop ]
    types:
      - completed

jobs:
  deploy-flathub:
    name: Deploy in Flathub
    runs-on: ubuntu-latest
    steps:

      - name: Checkout the target repository
        uses: actions/checkout@v4
        with:
          repository: one-ware/com.one_ware.OneWare
          token: ${{ secrets.HENDRIK_PERSONAL_TOKEN }}
          
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          path: source-repo
          
      - uses: mavrosxristoforos/get-xml-info@2.0
        name: Get Version
        id: get-oneware-version
        with:
          xml-file: 'source-repo/build/props/Base.props'
          xpath: "//*[local-name()='Project']/*[local-name()='PropertyGroup']/*[local-name()='StudioVersion']"

      - name: Make changes to the target repository
        run: |
          sed -i 's/tag: .*/tag: test/' com.one_ware.OneWare.yml

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b release-${{ steps.get-oneware-version.outputs.info }}
          git add com.one_ware.OneWare.yml
          git commit -m "Update com.one_ware.OneWare.yml"

      - name: Push changes and create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.HENDRIK_PERSONAL_TOKEN}}
          branch: main
          title: "Update Version to ${{ steps.get-oneware-version.outputs.info }}"
          body: "This is an automated pull request to update the version."
          labels: |
            update
            automated pr